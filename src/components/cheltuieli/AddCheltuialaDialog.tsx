'use client'

import { useState } from 'react'
import { zodResolver } from '@hookform/resolvers/zod'
import { Loader2 } from 'lucide-react'
import { useForm } from 'react-hook-form'
import { toast } from 'sonner'
import * as z from 'zod'

import { AppDrawer } from '@/components/app/AppDrawer'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Label } from '@/components/ui/label'
import { Textarea } from '@/components/ui/textarea'
import { generateClientId } from '@/lib/offline/generateClientId'

const CATEGORII_CHELTUIELI = [
  'Electricitate',
  'Motorina Transport',
  'Ambalaje',
  'Etichete',
  'Reparatii Utilaje',
  'Scule',
  'Fertilizare',
  'Pesticide',
  'Intretinere Curenta',
  'Cules',
  'Material Saditor',
  'Sistem Sustinere',
  'Sistem Irigatie',
  'Altele',
]

const cheltuialaSchema = z.object({
  client_sync_id: z.string().optional(),
  data: z.string().min(1, 'Data este obligatorie'),
  categorie: z.string().min(1, 'Selecteaza categoria'),
  suma_lei: z.string().min(1, 'Suma este obligatorie'),
  furnizor: z.string().optional(),
  descriere: z.string().optional(),
})

export type CheltuialaFormData = z.infer<typeof cheltuialaSchema>

interface AddCheltuialaDialogProps {
  open: boolean
  onOpenChange: (open: boolean) => void
  onSubmit: (data: CheltuialaFormData) => Promise<void>
}

const defaultValues = (): CheltuialaFormData => ({
  client_sync_id: undefined,
  data: new Date().toISOString().split('T')[0],
  categorie: '',
  suma_lei: '',
  furnizor: '',
  descriere: '',
})

export function AddCheltuialaDialog({ open, onOpenChange, onSubmit }: AddCheltuialaDialogProps) {
  const [isSubmitting, setIsSubmitting] = useState(false)

  const form = useForm<CheltuialaFormData>({
    resolver: zodResolver(cheltuialaSchema),
    defaultValues: defaultValues(),
  })

  const handleClose = () => {
    if (isSubmitting) return
    onOpenChange(false)
  }

  const handleSubmit = async (data: CheltuialaFormData) => {
    if (isSubmitting) return

    setIsSubmitting(true)
    try {
      await onSubmit({
        ...data,
        client_sync_id: data.client_sync_id ?? generateClientId(),
      })
      form.reset(defaultValues())
      onOpenChange(false)
    } catch (error: any) {
      const conflict = error?.status === 409 || error?.code === '23505'
      if (conflict) {
        toast.info('Inregistrarea era deja sincronizata.')
        onOpenChange(false)
        return
      }

      console.error('Error creating cheltuiala:', error)
      toast.error('Eroare la salvare.')
    } finally {
      setIsSubmitting(false)
    }
  }

  return (
    <AppDrawer
      open={open}
      onOpenChange={onOpenChange}
      title="Adauga cheltuiala"
      footer={
        <div className="grid grid-cols-2 gap-3">
          <Button type="button" variant="outline" className="agri-cta" onClick={handleClose} disabled={isSubmitting}>
            Anuleaza
          </Button>
          <Button
            type="button"
            className="agri-cta bg-[var(--agri-primary)] text-white hover:bg-emerald-700"
            onClick={form.handleSubmit(handleSubmit)}
            disabled={isSubmitting}
          >
            {isSubmitting ? (
              <>
                <Loader2 className="h-4 w-4 animate-spin" />
                <span className="ml-2">Se salveaza...</span>
              </>
            ) : (
              'Salveaza'
            )}
          </Button>
        </div>
      }
    >
      <form className="space-y-4" onSubmit={form.handleSubmit(handleSubmit)}>
        <div className="space-y-2">
          <Label htmlFor="chelt_data">Data</Label>
          <Input id="chelt_data" type="date" className="agri-control h-12" {...form.register('data')} />
          {form.formState.errors.data ? <p className="text-xs text-red-600">{form.formState.errors.data.message}</p> : null}
        </div>

        <div className="space-y-2">
          <Label htmlFor="chelt_categorie">Categorie</Label>
          <select id="chelt_categorie" className="agri-control h-12 w-full px-3 text-base" {...form.register('categorie')}>
            <option value="">Selecteaza categoria</option>
            {CATEGORII_CHELTUIELI.map((categorie) => (
              <option key={categorie} value={categorie}>
                {categorie}
              </option>
            ))}
          </select>
          {form.formState.errors.categorie ? <p className="text-xs text-red-600">{form.formState.errors.categorie.message}</p> : null}
        </div>

        <div className="space-y-2">
          <Label htmlFor="chelt_suma">Suma (lei)</Label>
          <Input
            id="chelt_suma"
            type="number"
            inputMode="decimal"
            pattern="[0-9]*"
            step="0.01"
            min="0"
            className="agri-control h-12"
            placeholder="Ex: 150.50"
            {...form.register('suma_lei')}
          />
          {form.formState.errors.suma_lei ? <p className="text-xs text-red-600">{form.formState.errors.suma_lei.message}</p> : null}
        </div>

        <div className="space-y-2">
          <Label htmlFor="chelt_furnizor">Furnizor / Magazin</Label>
          <Input id="chelt_furnizor" className="agri-control h-12" placeholder="Ex: Lidl, Dedeman, Petrom" {...form.register('furnizor')} />
        </div>

        <div className="space-y-2">
          <Label htmlFor="chelt_descriere">Descriere</Label>
          <Textarea
            id="chelt_descriere"
            rows={4}
            className="agri-control w-full px-3 py-2 text-base"
            placeholder="Ex: Electricitate pompa, factura 12345"
            {...form.register('descriere')}
          />
          <p className="text-xs text-[var(--agri-text-muted)]">Detalii suplimentare (factura, observatii etc.)</p>
        </div>
      </form>
    </AppDrawer>
  )
}
