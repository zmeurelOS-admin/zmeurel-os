'use client'

import { useEffect, useState } from 'react'
import { zodResolver } from '@hookform/resolvers/zod'
import { Loader2 } from 'lucide-react'
import { useForm } from 'react-hook-form'
import * as z from 'zod'

import { AppDialog } from '@/components/app/AppDialog'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Label } from '@/components/ui/label'
import { Textarea } from '@/components/ui/textarea'
import type { Cheltuiala } from '@/lib/supabase/queries/cheltuieli'

const CATEGORII_CHELTUIELI = [
  'Electricitate',
  'Motorina Transport',
  'Ambalaje',
  'Etichete',
  'Reparatii Utilaje',
  'Scule',
  'Fertilizare',
  'Pesticide',
  'Intretinere Curenta',
  'Cules',
  'Material Saditor',
  'Sistem Sustinere',
  'Sistem Irigatie',
  'Altele',
]

const cheltuialaSchema = z.object({
  data: z.string().min(1, 'Data este obligatorie'),
  categorie: z.string().min(1, 'Selecteaza categoria'),
  suma_lei: z.string().min(1, 'Suma este obligatorie'),
  furnizor: z.string().optional(),
  descriere: z.string().optional(),
})

export type EditCheltuialaFormData = z.infer<typeof cheltuialaSchema>

interface EditCheltuialaDialogProps {
  cheltuiala: Cheltuiala | null
  open: boolean
  onOpenChange: (open: boolean) => void
  onSubmit: (id: string, data: EditCheltuialaFormData) => Promise<void>
}

export function EditCheltuialaDialog({ cheltuiala, open, onOpenChange, onSubmit }: EditCheltuialaDialogProps) {
  const [isSubmitting, setIsSubmitting] = useState(false)

  const form = useForm<EditCheltuialaFormData>({
    resolver: zodResolver(cheltuialaSchema),
    defaultValues: {
      data: '',
      categorie: '',
      suma_lei: '',
      furnizor: '',
      descriere: '',
    },
  })

  useEffect(() => {
    if (cheltuiala && open) {
      form.reset({
        data: cheltuiala.data,
        categorie: cheltuiala.categorie ?? '',
        suma_lei: String(cheltuiala.suma_lei ?? ''),
        furnizor: cheltuiala.furnizor ?? '',
        descriere: cheltuiala.descriere ?? '',
      })
    }
  }, [cheltuiala, open, form])

  const handleClose = () => {
    if (isSubmitting) return
    onOpenChange(false)
  }

  const handleSubmit = async (data: EditCheltuialaFormData) => {
    if (!cheltuiala || isSubmitting) return

    setIsSubmitting(true)
    try {
      await onSubmit(cheltuiala.id, data)
      onOpenChange(false)
    } catch (error) {
      console.error('Error updating cheltuiala:', error)
    } finally {
      setIsSubmitting(false)
    }
  }

  if (!cheltuiala) return null

  return (
    <AppDialog
      open={open}
      onOpenChange={onOpenChange}
      title="Editeaza cheltuiala"
      footer={
        <div className="grid grid-cols-2 gap-3">
          <Button type="button" variant="outline" className="agri-cta" onClick={handleClose} disabled={isSubmitting}>
            Anuleaza
          </Button>
          <Button
            type="button"
            className="agri-cta bg-[var(--agri-primary)] text-white hover:bg-emerald-700"
            onClick={form.handleSubmit(handleSubmit)}
            disabled={isSubmitting}
          >
            {isSubmitting ? (
              <>
                <Loader2 className="h-4 w-4 animate-spin" />
                <span className="ml-2">Se salveaza...</span>
              </>
            ) : (
              'Salveaza'
            )}
          </Button>
        </div>
      }
    >
      <form className="space-y-4" onSubmit={form.handleSubmit(handleSubmit)}>
        <div className="space-y-2">
          <Label htmlFor="edit_chelt_data">Data</Label>
          <Input id="edit_chelt_data" type="date" className="agri-control h-12" {...form.register('data')} />
          {form.formState.errors.data ? <p className="text-xs text-red-600">{form.formState.errors.data.message}</p> : null}
        </div>

        <div className="space-y-2">
          <Label htmlFor="edit_chelt_categorie">Categorie</Label>
          <select id="edit_chelt_categorie" className="agri-control h-12 w-full px-3 text-base" {...form.register('categorie')}>
            <option value="">Selecteaza categoria</option>
            {CATEGORII_CHELTUIELI.map((categorie) => (
              <option key={categorie} value={categorie}>
                {categorie}
              </option>
            ))}
          </select>
          {form.formState.errors.categorie ? <p className="text-xs text-red-600">{form.formState.errors.categorie.message}</p> : null}
        </div>

        <div className="space-y-2">
          <Label htmlFor="edit_chelt_suma">Suma (lei)</Label>
          <Input
            id="edit_chelt_suma"
            type="number"
            inputMode="decimal"
            pattern="[0-9]*"
            step="0.01"
            min="0"
            className="agri-control h-12"
            placeholder="Ex: 150.50"
            {...form.register('suma_lei')}
          />
          {form.formState.errors.suma_lei ? <p className="text-xs text-red-600">{form.formState.errors.suma_lei.message}</p> : null}
        </div>

        <div className="space-y-2">
          <Label htmlFor="edit_chelt_furnizor">Furnizor / Magazin</Label>
          <Input
            id="edit_chelt_furnizor"
            className="agri-control h-12"
            placeholder="Ex: Lidl, Dedeman, Petrom"
            {...form.register('furnizor')}
          />
        </div>

        <div className="space-y-2">
          <Label htmlFor="edit_chelt_descriere">Descriere</Label>
          <Textarea
            id="edit_chelt_descriere"
            rows={4}
            className="agri-control w-full px-3 py-2 text-base"
            placeholder="Detalii suplimentare"
            {...form.register('descriere')}
          />
        </div>
      </form>
    </AppDialog>
  )
}
